<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>

        <!--Top menu item-->
        <menuitem id="octagono_gps_menu_root"
                  name="Octagono GPS"
                  web_icon="octagono_gps,static/description/icon.png"/>

        <menuitem id="octagono_gps_menu"
                  name="Vehículos"
                  parent="octagono_gps_menu_root"
                  sequence="2"/>

        <menuitem id="menu_octagono_config"
                  name="Configuracion"
                  parent="octagono_gps_menu_root"
                  sequence="6"/>

        <!--Octagono Order Kanban View-->
        <record id="view_octagono_gps_kanban" model="ir.ui.view">
            <field name="name">octagono.gps.kanban</field>
            <field name="model">octagono.gps</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_mobile">
                    <field name="id"/>
                    <field name="name"/>
                    <field name="partner_id"/>
                    <field name="date_order"/>
                    <field name="state"/>
                    <field name="currency_id"/>
                    <field name="image_small"/>
                    <field name="image"/>
                    <field name="image_medium"/>
                    <field name="model_id"/>
                    <field name="vin_sn"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                                <div class="o_kanban_record_top mb16">
                                    <div class="o_kanban_record_headings mt4">
                                        <strong class="o_kanban_record_title">
                                            <span>
                                                <t t-esc="record.partner_id.value"/>
                                            </span>
                                        </strong>
                                    </div>
                                    <div class="oe_kanban_bottom_right text-muted">
                                        <field name="model_id"/>
                                        <br/>
                                        <field name="license_plate"/>
                                        <br/>
                                        <field name="vin_sn"/>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left text-muted">
                                        <span>
                                            <t t-esc="record.name.value"/>
                                            <br/>
                                            <t t-esc="record.date_order.value"/>
                                        </span>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="state" widget="label_selection"
                                               options="{'classes': {'draft': 'default', 'cancel': 'default', 'done': 'success'}}"/>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!--Octagono Order Tree View-->
        <record id="view_octagono_gps_tree" model="ir.ui.view">
            <field name="name">octagono.gps.tree</field>
            <field name="model">octagono.gps</field>
            <field name="arch" type="xml">
                <tree string="Octagono GPS">
                    <field name="message_needaction" invisible="1"/>
                    <field name="active" invisible="1"/>
                    <field name="name"/>
                    <field name="confirmation_date"/>
                    <field name="partner_id"/>
                    <field name="user_id" invisible="1"/>
                    <field name="driver"/>
                    <field name="vin_sn"/>
                    <field name="license_plate"/>
                    <field name="currency_id" invisible="1"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <!--Octagono Order Form View-->
        <record id="view_octagono_gps_form" model="ir.ui.view">
            <field name="name">octagono.gps.form</field>
            <field name="model">octagono.gps</field>
            <field name="arch" type="xml">
                <form string="Octagono GPS" class="o_sale_order">
                    <header>
                        <button name="action_confirm" id="action_confirm"
                                string="Confirmar" class="btn-primary" type="object"
                                attrs="{'invisible': [('state', 'not in', ['sent'])]}"/>
                        <button name="action_confirm"
                                string="Confirmar" type="object"
                                attrs="{'invisible': [('state', 'not in', ['draft'])]}"/>
                        <button name="action_cancel" states="draft,sent,registered"
                                type="object" string="Cancelar"/>
                        <button name="action_draft" states="cancel" type="object" string="Establecer como borrador"/>
                        <button name="action_done" type="object" string="Bloquear" states="registered"
                                help="Si el registro está bloqueado, ya no podrá modificarla. Sin embargo, aún podrá facturar o entregar."/>
                        <button name="action_unlock" type="object" string="Desbloquear" states="done"
                                groups="sales_team.group_sale_manager"/>
                        <field name="state" widget="statusbar" statusbar_visible="draft,sent,registered"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button type="object"
                                    name="action_view_delivery"
                                    class="oe_stat_button"
                                    icon="fa-truck"
                                    attrs="{'invisible': [('delivery_count', '=', 0)]}">
                                <field name="delivery_count" widget="statinfo" string="Delivery"/>
                            </button>
                            <button name="toggle_active" type="object" class="oe_stat_button" icon="fa-archive">
                                <field name="active" widget="boolean_button" options='{"terminology": "archive"}'/>
                            </button>
                        </div>
                        <div>
                            <field name="image" widget="image" class="oe_avatar"/>
                        </div>
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="partner_id" domain="[('customer','=',True)]"
                                       context="{'search_default_customer':1, 'show_address': 1}"
                                       options='{"always_reload": True}'/>
                                <field name="partner_invoice_id" groups="sale.group_delivery_invoice_address"
                                       context="{'default_type':'invoice'}" options='{"always_reload": True}'/>
                                <field name="partner_shipping_id" groups="sale.group_delivery_invoice_address"
                                       context="{'default_type':'delivery'}" options='{"always_reload": True}'/>
                            </group>
                            <group>
                                <field name="driver"/>
                                <field name="validity_date"
                                       attrs="{'invisible': [('state', 'in', ['registered', 'done'])]}"
                                       invisible="1"/>
                                <field name="confirmation_date"
                                       attrs="{'invisible': [('state', 'in', ['draft', 'sent', 'cancel'])]}"/>
                                <field name="pricelist_id" groups="product.group_sale_pricelist" invisible="1"/>
                                <field name="currency_id" invisible="1"/>
                            </group>
                        </group>
                        <notebook>
                            <page string="Lineas de asignacion">
                                <field name="order_line" mode="tree,kanban"
                                       attrs="{'readonly': [('state', 'in', ('done','cancel'))]}">
                                    <form string="Sales Order Lines">
                                        <header>
                                            <field name="state" widget="statusbar"
                                                   statusbar_visible="draft,sent,registered"/>
                                        </header>
                                        <group>
                                            <group>
                                                <field name="product_updatable" invisible="1"/>
                                                <field name="product_id"
                                                       context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'company_id': parent.company_id}"
                                                       attrs="{'readonly': [('product_updatable', '=', False)]}"
                                                       force_save="1"
                                                />
                                                <field name="qty_delivered_updateable" invisible="1"/>
                                                <field name="price_subtotal" invisible="1"/>
                                                <label for="product_uom_qty" string="Ordered Quantity" invisible="1"/>
                                                <div>
                                                    <field name="product_uom_qty"
                                                           context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'uom_qty_change':True, 'company_id': parent.company_id}"
                                                           class="oe_inline" invisible="1"/>
                                                    <field name="product_uom" groups="product.group_uom"
                                                           class="oe_inline oe_no_button"
                                                           attrs="{'readonly': [('state', 'in', ('registered','done', 'cancel'))]}"
                                                           invisible="1"/>
                                                </div>
                                                <label for="qty_delivered" string="Delivered Quantity"
                                                       attrs="{'invisible': [('parent.state', 'not in', ['registered', 'done'])]}"
                                                       invisible="1"/>
                                                <div attrs="{'invisible': [('parent.state', 'not in', ['registered', 'done'])]}">
                                                    <field name="qty_delivered"
                                                           attrs="{'readonly': [('qty_delivered_updateable', '=', False)]}"
                                                           invisible="1"/>
                                                </div>
                                                <field name="price_unit" invisible="1"/>
                                                <!--new-->
                                                <field name="product_packaging"
                                                       attrs="{'invisible': [('product_id', '=', False)]}"
                                                       context="{'default_product_id': product_id, 'tree_view_ref':'product.product_packaging_tree_view', 'form_view_ref':'product.product_packaging_form_view'}"
                                                       domain="[('product_id','=',product_id)]"
                                                       groups="product.group_stock_packaging"/>
                                                <field name="route_id"
                                                       options="{'no_create': True}"/>
                                            </group>
                                        </group>
                                        <label for="name"/>
                                        <field name="name"/>
                                    </form>
                                    <tree string="Octagono GPS Lines" editable="bottom">
                                        <field name="sequence" widget="handle"/>
                                        <field name="product_updatable" invisible="1"/>
                                        <field name="product_id"
                                               attrs="{'readonly': [('product_updatable', '=', False)]}"
                                               force_save="1"
                                               context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'company_id': parent.company_id}"
                                        />
                                        <field name="name"/>
                                        <field name="product_uom_qty"
                                               string="Ordered Qty"
                                               context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'company_id': parent.company_id}"
                                               invisible="1"/>
                                        <field name="product_uom"
                                               attrs="{'readonly': [('state', 'in', ('registered','done', 'cancel'))]}"
                                               context="{'company_id': parent.company_id}"
                                               groups="product.group_uom"
                                               options='{"no_open": True}'
                                               invisible="1"/>
                                        <field name="state" invisible="1"/>
                                        <field name="currency_id" invisible="1"/>
                                        <!--new-->
                                        <field name="route_id"
                                               options="{'no_create': True}"
                                               invisible="1"/>
                                    </tree>
                                    <kanban class="o_kanban_mobile">
                                        <field name="product_id"/>
                                        <field name="product_uom_qty"/>
                                        <field name="product_uom" groups="product.group_uom"/>
                                        <field name="price_subtotal"/>
                                        <field name="price_unit"/>
                                        <templates>
                                            <t t-name="kanban-box">
                                                <div t-attf-class="oe_kanban_card oe_kanban_global_click">
                                                    <div class="row">
                                                        <div class="col-xs-8">
                                                            <strong>
                                                                <span>
                                                                    <t t-esc="record.product_id.value"/>
                                                                </span>
                                                            </strong>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-xs-12 text-muted">
                                                            <span>Unit Price:
                                                                <t t-esc="record.price_unit.value"/>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr/>
                                            </t>
                                        </templates>
                                    </kanban>
                                </field>
                            </page>
                            <page string="Datos del vehiculo">
                                <group col="2" string="Caracteristicas">
                                    <group>
                                        <field name="model_id"/>
                                        <field name="model_year"/>
                                        <field name="vin_sn"/>
                                    </group>
                                    <group>
                                        <field name="license_plate"/>
                                        <field name="color"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Datos de la instalacion">
                                <group col="1">
                                    <group>
                                        <field name="blocking_type"/>
                                        <field name="install_date"/>
                                        <field name="installer_id" options="{'no_create': True}"/>
                                    </group>
                                </group>
                            </page>
                            <page string="Otra información">
                                <group col="1">
                                    <group>
                                        <field name="note" placeholder="Alguna nota adicional ..."/>
                                        <field name="company_id" options="{'no_create': True}"
                                               groups="base.group_multi_company"/>
                                    </group>
                                </group>
                                <group col="1">
                                    <group string="Información de envío" name="octagono_shipping">
                                        <field name="warehouse_id" options="{'no_create': True}"/>
                                        <field name="incoterm" widget="selection"/>
                                        <field name="picking_policy"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread"/>
                    </div>
                </form>
            </field>
        </record>

        <!-- inherited view to make the order lines list in the form non-editable
             for the members of some usability groups -->
        <record id="view_octagono_gps_form_editable_list" model="ir.ui.view">
            <field name="name">octagono.gps.form.editable.list</field>
            <field name="model">octagono.gps</field>
            <field name="inherit_id" ref="octagono_gps.view_octagono_gps_form"/>
            <!--<field name="groups_id" eval="[(4, ref('product.group_stock_packaging'))]"/>-->
            <field name="arch" type="xml">
                <xpath expr="//field[@name='order_line']/tree" position="attributes">
                    <attribute name="editable"/>
                </xpath>
            </field>
        </record>

        <!--Octagono Order Search View-->
        <record id="view_octagono_gps_filter" model="ir.ui.view">
            <field name="name">octagono.gps.search</field>
            <field name="model">octagono.gps</field>
            <field name="arch" type="xml">
                <search string="Search Octagono GPS">
                    <field name="name" string="Octagono Order"
                           filter_domain="['|','|',('name','ilike',self),('client_order_ref','ilike',self),('partner_id','child_of',self)]"/>
                    <field name="partner_id" operator="child_of"/>
                    <field name="user_id"/>
                    <field name="product_id"/>
                    <filter string="Mis registros" domain="[('user_id','=',uid)]" name="my_octagono_gps_filter"/>
                    <filter string="Borradores" name="draft" domain="[('state','=','draft')]"/>
                    <filter string="Registros enviados" name="sent" domain="[('state','=','sent')]"/>
                    <filter string="Confirmados" name="registered" domain="[('state','in',('registered','done'))]"/>
                    <separator/>
                    <filter string="Unread Messages" name="message_needaction"
                            domain="[('message_needaction','=',True)]"/>
                    <separator/>
                    <filter string="My Activities" name="activities_my"
                            domain="[('activity_ids.user_id', '=', uid)]"/>
                    <separator/>
                    <filter string="Late Activities" name="activities_overdue"
                            domain="[('activity_ids.date_deadline', '&lt;', context_today().strftime('%Y-%m-%d'))]"
                            help="Show all records which has next action date is before today"/>
                    <filter string="Today Activities" name="activities_today"
                            domain="[('activity_ids.date_deadline', '=', context_today().strftime('%Y-%m-%d'))]"/>
                    <filter string="Future Activities" name="activities_upcoming_all"
                            domain="[('activity_ids.date_deadline', '&gt;', context_today().strftime('%Y-%m-%d'))]"/>
                    <group expand="1" string="Group By">
                        <filter string="Usuario" domain="[]" context="{'group_by':'user_id'}"/>
                        <filter name="propetario" string="Propetario" domain="[]" context="{'group_by':'partner_id'}"/>
                        <filter string="Mes del registro" domain="[]" context="{'group_by':'date_order'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!--Octagono Order Action Window-->
        <record id="action_octagono_gps" model="ir.actions.act_window">
            <field name="name">Octagono Registros</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">octagono.gps</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,kanban,form</field>
            <field name="search_view_id" ref="view_octagono_gps_filter"/>
            <field name="context">{"search_default_propetario": True,}</field>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Crea un nuevo registro, el primer paso para registrar un vehiculo.
                </p>
            </field>
        </record>

        <menuitem id="menu_octagono_gps"
                  action="action_octagono_gps"
                  parent="octagono_gps_menu"/>

        <!--=================== mail ====================-->
        <record id="mt_octagono_gps_confirmed" model="mail.message.subtype">
            <field name="name">Octagono Order Confirmed</field>
            <field name="res_model">octagono.gps</field>
            <field name="default" eval="False"/>
            <field name="description">Quotation confirmed</field>
        </record>

        <!--Octagono Order Line Tree View-->
        <record id="view_octagono_gps_line_tree" model="ir.ui.view">
            <field name="name">octagono.gps.line.tree</field>
            <field name="model">octagono.gps.line</field>
            <field name="arch" type="xml">
                <tree string="Octagono Order Lines" create="false">
                    <field name="product_id" invisible="1"/>
                    <field name="order_id"/>
                    <field name="order_partner_id"/>
                    <field name="name"/>
                    <field name="salesman_id"/>
                    <field name="product_uom_qty" string="Qty"/>
                    <field name="qty_delivered"/>
                    <field name="product_uom" string="Unit of Measure" groups="product.group_uom"/>
                    <field name="route_id" options="{'no_create': True}"/>
                </tree>
            </field>
        </record>

        <!--Octagono Order Line Search View-->
        <record id="view_octagono_gps_line_filter" model="ir.ui.view">
            <field name="name">octagono.gps.line.select</field>
            <field name="model">octagono.gps.line</field>
            <field name="arch" type="xml">
                <search string="Search Octagono GPS Line">
                    <filter string="My Octagono Order Lines" domain="[('salesman_id','=',uid)]"
                            help="Octagono Order Lines related to a Sales Order of mine"/>
                    <field name="order_id"/>
                    <field name="order_partner_id" operator="child_of"/>
                    <field name="product_id"/>
                    <field name="salesman_id"/>
                    <group expand="0" string="Group By">
                        <filter string="Product" domain="[]" context="{'group_by':'product_id'}"/>
                        <filter string="Order" domain="[]" context="{'group_by':'order_id'}"/>
                        <filter string="Usuario" domain="[]" context="{'group_by':'salesman_id'}"/>
                    </group>
                </search>
            </field>
        </record>

        <!--Octagono Order Line Action Window-->
        <record id="action_product_octagono_list" model="ir.actions.act_window">
            <field name="name">Octagono Order Lines</field>
            <field name="res_model">octagono.gps.line</field>
            <field name="view_mode">tree</field>
            <field name="context">{'search_default_product_id': [active_id], 'default_product_id': active_id}</field>
            <field name="domain">[('state', 'in', ['registered', 'done'])]</field>
        </record>

        <!--================= MAIL ============-->
        <record id="mt_register_confirmed" model="mail.message.subtype">
            <field name="name">Octagono GPS Confirmed</field>
            <field name="res_model">octagono.gps</field>
            <field name="default" eval="True"/>
            <field name="description">Registro Confirmado</field>
        </record>

        <record id="mt_register_sent" model="mail.message.subtype">
            <field name="name">Octagono GPS Sent</field>
            <field name="res_model">octagono.gps</field>
            <field name="default" eval="True"/>
            <field name="description">Registro Enviado</field>
        </record>

    </data>
</odoo>